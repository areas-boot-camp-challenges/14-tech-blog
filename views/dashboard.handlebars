<section class="grid grid-cols-1 justify-items-center gap-2 p-4">
	<h2 class="text-xl">Dashboard</h2>
	{{#each posts as |post|}}
		<article class="published-post w-full sm:w-3/4 border rounded-lg p-4 grid grid-cols-2" data-post-id="{{post.postId}}" data-post-title="{{post.postTitle}}" data-post="{{post.post}}">
			<section class="underline">{{post.postTitle}}</section>
			<section class="justify-self-end">Published {{formatDate post.postDate}}</section>
		</article>
	{{/each}}
	<button id="new-post" class="w-64 border rounded-lg p-4">New Post</button>
</section>

<section id="publish-post" class="grid grid-cols-1 justify-items-center gap-2 p-4">
</section>

<article id="user-id" data-user-id="{{userId}}"></article>

<!-- ** -->

<script>
	// Display a "Publish Post" form.
	function displayPublishForm(addOrEdit) {
		// Hide the "New Post" button and clear the form section.
		document.getElementById("new-post").hidden = true
		document.getElementById("publish-post").innerHTML = ""
		// Create the elements.
		const postHeader = document.createElement("h3")
		if (addOrEdit === "add") {
			postHeader.innerHTML = "Publish Post"
		} else if (addOrEdit === "edit") {
			postHeader.innerHTML = "Edit Post"
		}
		postHeader.className = ""
		const postTitleInput = document.createElement("input")
		postTitleInput.id = "post-title"
		postTitleInput.className = "w-full sm:w-3/4 border rounded-lg p-4 border-gray-300 text-black"
		postTitleInput.type = "text"
		postTitleInput.placeholder = "Enter a title"
		const postTextarea = document.createElement("textarea")
		postTextarea.id = "post"
		postTextarea.className = "w-full sm:w-3/4 border rounded-lg p-4 border-gray-300 text-black"
		postTextarea.placeholder = "Say more..."
		const publishButton = document.createElement("button")
		publishButton.innerHTML = "Publish"
		publishButton.id = "publish"
		publishButton.className = "w-64 border rounded-lg p-4 bg-green-400"
		const cancelButton = document.createElement("button")
		cancelButton.innerHTML = "Cancel"
		cancelButton.id = "cancel"
		cancelButton.className = "w-64 border rounded-lg p-4 bg-yellow-400"
		const deleteButton = document.createElement("button")
		deleteButton.innerHTML = "Delete"
		deleteButton.id = "delete"
		deleteButton.className = "w-64 border rounded-lg p-4 bg-red-400"
		// Append the elements to the form.
		const postForm = document.getElementById("publish-post")
		postForm.appendChild(postHeader)
		postForm.appendChild(postTitleInput)
		postForm.appendChild(postTextarea)
		postForm.appendChild(publishButton)
		postForm.appendChild(cancelButton)
		if (addOrEdit === "edit") {
			postForm.appendChild(deleteButton)
		}
	}

	// Add a new post.
	document.getElementById("new-post").addEventListener("click", () => {
		// Display the "Publish Post" form.
		displayPublishForm("add")
		// Publish the post.
		document.getElementById("publish").addEventListener("click", async () => {
			// Prepare the post.
			const postTitle = document.getElementById("post-title").value.trim()
			const post = document.getElementById("post").value.trim()
			const postDate = new Date()
			const userId = document.getElementById("user-id").getAttribute("data-user-id")
			// Call the API.
			if (postTitle && post && postDate && userId) {
				const response = await fetch(`api/post`, {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({
						postTitle,
						post,
						postDate,
						userId,
					}),
				})
				// Handle the response.
				if (response.ok) {
					document.location.replace("/dashboard")
				} else {
					alert(response.statusText)
				}
			}
		})
		// Cancel.
		document.getElementById("cancel").addEventListener("click", () => {
			document.location.replace("/dashboard")
		})
	})

	// Edit an existing post.
	document.querySelectorAll(".published-post").forEach((post) => {
		post.addEventListener("click", async (e) => {
			// Prepare the post.
			const postId = e.target.closest(".published-post").getAttribute("data-post-id")
			const postTitle = e.target.closest(".published-post").getAttribute("data-post-title")
			const post = e.target.closest(".published-post").getAttribute("data-post")
			// Display the "Edit Post" form.
			displayPublishForm("edit")
			// Add the post values to the form.
			document.getElementById("post-title").value = postTitle
			document.getElementById("post").value = post
			// Edit the post.
			document.getElementById("publish").addEventListener("click", async () => {
				// Prepare the post.
				const postTitle = document.getElementById("post-title").value.trim()
				const post = document.getElementById("post").value.trim()
				// Call the API.
				if (postId && postTitle && post) {
					const response = await fetch(`api/post/${postId}`, {
						method: "PATCH",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							postTitle,
							post,
						}),				
					})
					// Handle the response.
					if (response.ok) {
						document.location.replace("/dashboard")
					} else {
						alert(response.statusText)
					}
				}
			})
			// Cancel.
			document.getElementById("cancel").addEventListener("click", () => {
				document.location.replace("/dashboard")
			})			
			// Delete.
			document.getElementById("delete").addEventListener("click", async () => {
				// Call the API.
				if (postId) {
					const response = await fetch(`api/post/${postId}`, {
						method: "DELETE",
						headers: { "Content-Type": "application/json" },
					})
					// Handle the response.
					if (response.ok) {
						document.location.replace("/dashboard")
					} else {
						alert(response.statusText)
					}
				}
			})
		})
	})
</script>
